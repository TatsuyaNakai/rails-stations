<div class="container my-4">
  <div class="row">
    <div class="col-md-4">
      <div class="movie-image">
        <%= image_tag(@movie.image_url, class: 'img-fluid rounded') if @movie.image_url.present? %>
      </div>
    </div>
    
    <div class="col-md-8">
      <div class="movie-info">
        <p class="status">
          <%= @movie.is_showing ? '公開中' : '終了' %>
        </p>
        <h2 class="mt-3"><%= @movie.name %></h2>
        <p><strong>Release Year:</strong> <%= @movie.year %></p>
        <p class="description">
          <%= @movie.description %>
        </p>
      </div>
    </div>
  </div>

  <div class="reservation mt-4">
    <%= form_with url: reservation_movie_path(@movie), method: :get, local: true do %>
      <div class="form-group">
        <%= label_tag :date, '上映日を選択' %>
        <%= select_tag :date, options_for_select(@dates), include_blank: '選択してください', id: 'date-select', class: 'form-control' %>
      </div>

      <div id="schedule-container">
        <div class="form-group">
          <%= label_tag :schedule_id, '上映時刻を選択' %>
          <%= select_tag :schedule_id, options_for_select(@schedules.map { |s| ["#{l(s.start_time, format: :yyyymmddahhmm)}~#{l(s.end_time, format: :yyyymmddahhmm)}", s.id] }), id: 'schedule-select', class: 'form-control' %>
        </div>
        <button type="submit" class="btn btn-primary">座席を予約する</button>
      </div>
    <% end %>
  </div>

  <div class="mt-4">
    <%= link_to 'Back', movies_path, class: 'btn btn-secondary' %>
  </div>
</div>

<script>
  const parseDate = (dateObj) => {
    const week = ['日', '月', '火', '水', '木', '金', '土'];

    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    const date = week[dateObj.getDay()];
    const hours = String(dateObj.getHours()).padStart(2, '0');
    const minutes = String(dateObj.getMinutes()).padStart(2, '0');

    return { year, month, day, date, hours, minutes }
  }

  document.addEventListener('turbolinks:load', function() {
    // スケジュールデータをJavaScriptの変数に埋め込む
    const schedules = <%= @schedules.to_json.html_safe %>;
    const scheduleSelect = $('#schedule-select');

    $('#date-select').on('change', function() {
      const selectedDate = $(this).val();
      scheduleSelect.empty();

      const filteredSchedules = schedules.filter(function(s) {
        const dateObj = new Date(s.start_time)
        const { year, month, day } = parseDate(dateObj)
        
        const formatDate = `${year}-${month}-${day}`
        return formatDate === selectedDate;
      });

      const elms = selectedDate === '' ? schedules : filteredSchedules
      elms.forEach(function(s) {
        const startDateObj = new Date(s.start_time)
        const endDateObj = new Date(s.end_time)
        const formatDate = (dateObj) => {
          const { year, month, day, date, hours , minutes } = parseDate(startDateObj)
          return `${year}年${month}月${day}日(${date})${hours}時${minutes}分`;
        }

        scheduleSelect.append(new Option(`${formatDate(startDateObj)} ~ ${formatDate(endDateObj)}`, s.id));
      });
    });
  });
</script>